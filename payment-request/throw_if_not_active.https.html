<!DOCTYPE html>
<meta charset=utf-8>
<title>PaymentRequest show() throws if doc is not fully active</title>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<link rel="help" href="https://w3c.github.io/payment-request/#dom-paymentrequest-show()">
<body>
<script>
const validMethod = Object.freeze({
  supportedMethods: "basic-card",
});
const validMethods = Object.freeze([validMethod]);
const validAmount = Object.freeze({
  currency: "USD",
  value: "5.00",
});
const validDetails = {
  total: {
    label: "Total due",
    amount: validAmount,
  },
};

function getLoadedPaymentRequest(iframe, url) {
  return new Promise(resolve => {
    iframe.addEventListener(
      "load",
      () => {
        const { PaymentRequest } = iframe.contentWindow;
        const request = new PaymentRequest(validMethods, validDetails);
        resolve(request);
      },
      { once: true }
    );
    iframe.src = url;
  });
}

promise_test(async t => {
  // check that PaymentRequests can be constructed.
  new PaymentRequest(validMethods, validDetails);
  const iframe = document.createElement("iframe");
  iframe.allowPaymentRequest = true;
  document.body.appendChild(iframe);

  // We first got to page1.html, grab a PaymentRequest instance.
  const request1 = await getLoadedPaymentRequest(
    iframe,
    "/payment-request/resources/page1.html"
  );

  // We navigate the iframe again, putting request1's document into a inactive state.
  const request2 = await getLoadedPaymentRequest(
    iframe,
    "/payment-request/resources/page2.html"
  );

  // Now, request1's relevant global object's document is no longer active.
  // So, call .show(), and make sure it rejects appropriately.
  await promise_rejects(
    t,
    "AbortError",
    request1.show(),
    "Inactive document, so must throw AbortError"
  );

  // Request2 has an active document tho, so:
  request2.show();
  await request2.abort();
  await promise_rejects(
    t,
    "InvalidStateError",
    request2.show(),
    "Abort already called, so InvalidStateError"
  );
  iframe.remove();
}, "PaymentRequest.show() throws if the document is not active");

promise_test(async t => {
  // check that PaymentRequests can be constructed.
  new PaymentRequest(validMethods, validDetails);
  // We create two iframes, and nest them. Wait for both of them to load.
  const iframe = document.createElement("iframe");
  iframe.allowPaymentRequest = true;
  document.body.appendChild(iframe);
  const request = await new Promise(resolve => {
    iframe.addEventListener(
      "load",
      () => {
        const innerIframe = iframe.contentDocument.createElement("iframe");
        innerIframe.allowPaymentRequest = true;
        innerIframe.addEventListener(
          "load",
          () => {
            // We create an instance of the inner iframe's PaymentRequest()
            const { PaymentRequest } = innerIframe.contentWindow;
            const request = new PaymentRequest(validMethods, validDetails);
            resolve(request);
          },
          { once: true }
        );
        innerIframe.src = "/payment-request/resources/page2.html";
        iframe.contentDocument.body.appendChild(innerIframe);
      },
      { once: true }
    );
    iframe.src = "/payment-request/resources/page1.html";
  });

  // Navigate the outer iframe to a new location. Wait for the load event to fire.
  await new Promise(resolve => {
    iframe.addEventListener("load", resolve);
    iframe.src = "/payment-request/resources/page2.html";
  });
  // Now, request's relevant global object's document is still active
  // (it is the active document of the inner iframe), but is not fully active
  // (since the parent of the inner iframe is itself no longer active).
  // So, call pr.show() and make sure it rejects appropriately.
  await promise_rejects(
    t,
    "AbortError",
    request.show(),
    "Active, but not fully active, so must throw AbortError"
  );
  iframe.remove();
}, "PaymentRequest.show() throws if the document is active, but not fully active");

done();


</script>
